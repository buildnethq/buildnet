syntax = "proto3";

package buildnet.v5;

option go_package = "github.com/buildnethq/buildnet/hub/gen/buildnet/v5;buildnetv5";

import "buildnet/v5/common.proto";

enum CryptoSuite {
  CRYPTO_SUITE_UNSPECIFIED = 0;
  SUITE_X25519_CHACHA20POLY1305_BLAKE3 = 1;
  SUITE_X25519_AES256GCM_BLAKE3 = 2;
  SUITE_HYBRID_X25519_KYBER_CHACHA20POLY1305_BLAKE3 = 10; // policy-gated
}

enum HandshakePattern {
  HANDSHAKE_PATTERN_UNSPECIFIED = 0;
  PATTERN_XX = 1;
  PATTERN_IK = 2;
}

message NodeIdentity {
  bytes node_id = 1;
  bytes identity_pub = 2;
  bytes dh_pub = 3;
  bytes attestation = 4;
}

message SuiteOffer {
  repeated CryptoSuite supported_suites = 1;
  repeated HandshakePattern supported_patterns = 2;
  bool require_pq_hybrid = 3;
}

enum FlowMode {
  FLOW_MODE_UNSPECIFIED = 0;
  FLOW_MODE_STANDARD = 1;
  FLOW_MODE_PADDED_BATCHED = 2;
  FLOW_MODE_COVER_TRAFFIC = 3;
}

message FlowPolicy {
  FlowMode mode = 1;
  repeated uint32 size_buckets = 2;
  uint32 control_tick_ms = 3;
  uint32 cover_bytes_per_sec = 4;
}

message ClientHello {
  NodeIdentity client = 1;
  SuiteOffer offer = 2;
  bytes responder_hint_node_id = 3;
  bytes client_nonce = 4;
  FlowPolicy requested_flow = 5;
}

message ServerHello {
  NodeIdentity server = 1;
  CryptoSuite selected_suite = 2;
  HandshakePattern selected_pattern = 3;
  bytes server_nonce = 4;
  FlowPolicy effective_flow = 5;
}

message HandshakeMessage { bytes payload = 1; }

message HandshakeFinish {
  bytes transcript_hash = 1;
  bytes session_id = 2;
  bytes signature = 3;
}

enum ChannelKind {
  CHANNEL_KIND_UNSPECIFIED = 0;
  CHANNEL_CONTROL = 1;
  CHANNEL_DATA = 2;
  CHANNEL_EVENT = 3;
  CHANNEL_TELEMETRY = 4;
}

message AckRange { uint64 start = 1; uint64 end_inclusive = 2; }

message EnvelopeHeader {
  bytes session_id = 1;
  bytes msg_id = 2;
  ChannelKind channel = 3;
  uint64 stream_id = 4;
  bytes sender_node_id = 5;
  repeated bytes recipient_node_ids = 6;
  HybridLogicalTime hlc = 7;
  uint64 seq_no = 8;
  repeated AckRange acks = 9;
  string payload_type = 10;
  uint32 padded_to_bytes = 11;
}

message SecureEnvelope {
  EnvelopeHeader header = 1;
  bytes ciphertext = 2;
  bytes auth_tag = 3;
  bytes nonce = 4;
  bytes prev_event_hash_hint = 5;
}

service TransportService {
  rpc OpenSession(stream TransportFrame) returns (stream TransportFrame);
}

message TransportFrame {
  oneof frame {
    ClientHello client_hello = 1;
    ServerHello server_hello = 2;
    HandshakeMessage handshake = 3;
    HandshakeFinish finish = 4;
    SecureEnvelope envelope = 10;
    uint64 ping_ms = 20;
    uint64 pong_ms = 21;
  }
}
